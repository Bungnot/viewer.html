<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡πâ‡∏á‡πÑ‡∏ü - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πà‡∏ô‡πâ‡∏≠‡∏¢</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #333333;
      --red-btn: #ef4444;
      --red-btn-border: #b91c1c;
      --primary: #3b82f6;
    }

    * { box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); }
    
    /* ---------------------------------------------------
       1. ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡πÜ (Welcome Screen)
       --------------------------------------------------- */
    #welcome-screen {
      position: fixed; inset: 0;
      background: #000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 99999; padding: 20px; text-align: center;
    }
    .welcome-btn {
      background: var(--red-btn); color: white; border: none;
      padding: 40px 20px; border-radius: 20px; font-size: 2.2rem; font-weight: 900;
      cursor: pointer; width: 100%; max-width: 450px; line-height: 1.5;
      box-shadow: 0 0 30px rgba(239,68,68,0.5);
      animation: pulse 2s infinite;
    }
    .welcome-sub { margin-top: 25px; font-size: 1.8rem; color: #fff; font-weight: bold; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* ---------------------------------------------------
       2. ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á)
       --------------------------------------------------- */
    .app { padding: 20px; max-width: 1000px; margin: 0 auto; padding-bottom: 100px; }
    
    .header-title {
      text-align: center; font-size: 2.5rem; color: #7f1d1d; font-weight: 900; margin-bottom: 20px;
    }
    
    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô */
    .instruction-box {
      background: #fffbeb; 
      border: 3px dashed #f59e0b; 
      color: #b45309;
      padding: 20px;
      border-radius: 15px;
      font-size: 1.6rem;
      text-align: center;
      margin-bottom: 25px;
      line-height: 1.5;
      font-weight: bold;
    }

    .search-wrap { margin-bottom: 30px; }
    .search-wrap input {
      width: 100%; padding: 20px; font-size: 1.8rem; border: 3px solid #7f1d1d;
      border-radius: 15px; text-align: center; outline: none;
    }
    .search-wrap input::placeholder { color: #aaa; }

    /* Grid ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏¢‡∏™‡∏µ‡πÅ‡∏î‡∏á */
    .camp-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
      gap: 15px;
    }
    .camp-btn-red {
      background: var(--red-btn); color: white; border: 2px solid var(--red-btn-border);
      padding: 25px 10px; border-radius: 10px; font-size: 1.4rem; font-weight: bold;
      cursor: pointer; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      word-break: break-word; line-height: 1.3;
    }
    .camp-btn-red:active { transform: scale(0.95); }

    /* ---------------------------------------------------
       3. ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ)
       --------------------------------------------------- */
    #detailOverlay {
      display: none; position: fixed; inset: 0; background: #fff;
      z-index: 10000; overflow-y: auto; padding: 20px;
    }
    .close-overlay-btn {
      background: #333; color: white; width: 100%; padding: 20px;
      border: none; border-radius: 15px; font-size: 1.8rem; font-weight: bold;
      margin-bottom: 20px; cursor: pointer;
    }
    
    .detail-title { font-size: 2.5rem; color: #7f1d1d; font-weight: 900; text-align: center; margin-bottom: 10px; }
    .stat-box {
      background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 15px;
      padding: 20px; margin-bottom: 20px; text-align: center;
    }
    .stat-box.big { border-color: #3b82f6; background: #eff6ff; }
    .stat-box .label { font-size: 1.2rem; color: #64748b; margin-bottom: 5px; }
    .stat-box .val { font-size: 2rem; font-weight: 900; color: #0f172a; }
    .stat-box.big .val { font-size: 3rem; color: #1d4ed8; }
    
    .history-card {
      border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px;
      margin-bottom: 15px; font-size: 1.4rem; font-weight: bold;
    }
    .history-card.win { border-left: 8px solid #22c55e; background: #f0fdf4; }
    .history-card.lose { border-left: 8px solid #ef4444; background: #fef2f2; }
    .history-card.jao { border-left: 8px solid #f59e0b; background: #fffbeb; }

    .inline-actions { display: flex; gap: 10px; margin-top: 10px; }
    .mini-btn { padding: 10px 15px; font-size: 1.2rem; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;}
    .mini-btn.edit { background: #e2e8f0; color: #333; }
    .mini-btn.danger { background: #fee2e2; color: #ef4444; }

    /* ---------------------------------------------------
       4. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
       --------------------------------------------------- */
    .fab {
      position: fixed; right: 20px; bottom: 20px; z-index: 30; border: none; border-radius: 999px;
      padding: 15px 20px; font-weight: 900; font-size: 1.2rem; color: #fff; cursor: pointer;
      background: linear-gradient(135deg, #7c3aed, #2563eb); box-shadow: 0 10px 24px rgba(37,99,235,.5);
    }
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.85); display: none;
      align-items: center; justify-content: center; z-index: 50; padding: 20px;
    }
    .modal.show { display: flex; }
    .sheet {
      width: 100%; max-width: 600px; background: #fff; border-radius: 20px;
      max-height: 90vh; overflow: auto; color: #000;
    }
    .sheet-head { padding: 20px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
    .sheet-title { font-size: 1.5rem; font-weight: bold; }
    .x-btn { background: #ef4444; color: white; border: none; padding: 10px 15px; border-radius: 10px; font-size: 1.2rem; cursor: pointer; }
    .sheet-body { padding: 20px; }
    .card { border: 1px solid #ccc; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
    .field label { font-size: 1.2rem; font-weight: bold; display: block; margin-bottom: 5px; }
    .field input, .field select { width: 100%; padding: 15px; font-size: 1.2rem; border: 1px solid #ccc; border-radius: 10px; margin-bottom: 15px; }
    .main-btn { width: 100%; padding: 15px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; color: white; }
    .main-btn.primary { background: #3b82f6; }
    .main-btn.green { background: #22c55e; margin-bottom: 10px; }
    .main-btn.gray { background: #64748b; margin-top: 10px; }
    .admin-actions-top { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
  </style>
</head>
<body>

  <div id="welcome-screen">
    <button class="welcome-btn" onclick="startApp()">
      ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥<br>‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏¢
    </button>
    <div class="welcome-sub">* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πà‡∏ô‡πâ‡∏≠‡∏¢ *</div>
  </div>

  <div class="app">
    <div class="header-title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢</div>
    
    <div class="instruction-box">
      üì¢ <b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</b><br> 
      ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <span style="color:var(--red-btn);">"‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢"</span> ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
    </div>

    <div class="search-wrap">
      <input id="searchInput" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." />
    </div>

    <div id="campGrid" class="camp-grid">
      <div style="font-size: 1.5rem; text-align: center; width: 100%;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>
  </div>

  <div id="detailOverlay">
    <button class="close-overlay-btn" onclick="closeDetail()">‚ùå ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    <div id="detailContent">
      </div>
  </div>

  <button id="adminFab" class="fab">üîê ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>

  <div id="adminModal" class="modal">
    <div class="sheet">
      <div class="sheet-head">
        <div class="sheet-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</div>
        <button id="closeAdminModal" class="x-btn">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="sheet-body">
        <div class="card" style="background:#f8fafc; border-color:#cbd5e1;">
          <div id="adminStateText" style="font-size:1.1rem; margin-bottom:10px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
          <button id="logoutBtn" class="main-btn gray" style="display:none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div id="adminLoginCard" class="card">
          <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
          <div class="field">
            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
            <input type="email" id="adminEmailInput" placeholder="admin@email.com">
          </div>
          <div class="field">
            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <input type="password" id="adminPasswordInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
          </div>
          <button id="loginBtn" class="main-btn primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div id="adminAddCampCard" class="card" style="display:none;">
          <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</h3>
          <div class="field">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢</label>
            <input type="text" id="newCampName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ö‡∏á‡∏Ñ‡πå‡∏ó‡∏≠‡∏á">
          </div>
          <button id="addCampBtn" class="main-btn green">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏¢</button>
        </div>

        <div id="adminAddRecordCard" class="card" style="display:none;">
          <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ / ‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏ö‡∏±‡πâ‡∏á‡πÑ‡∏ü</h3>
          <div class="field">
            <label>‡∏Ñ‡πà‡∏≤‡∏¢</label>
            <select id="recordCampSelect"></select>
          </div>
          <div class="field">
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="recordDate">
          </div>
          <div class="field">
            <label>‡∏™‡∏Å‡∏≠‡∏£‡πå</label>
            <input type="number" id="recordScore" min="0" placeholder="355">
          </div>
          <div class="field">
            <label>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
            <select id="recordResult">
              <option value="win">‚úÖ ‡∏ä‡∏ô‡∏∞</option>
              <option value="lose">‚ùå ‡πÅ‡∏û‡πâ</option>
              <option value="jao">‚õîÔ∏è ‡∏à‡∏≤‡∏ß</option>
            </select>
          </div>
          <button id="addRecordBtn" class="main-btn primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ‚úÖ ‡∏Ñ‡πà‡∏≤ Firebase ‡πÄ‡∏î‡∏¥‡∏°
    const firebaseConfig = {
      apiKey: "AIzaSyBo2QyLIW5q6AFAtTYLrqBr5wgssYvwgPI",
      authDomain: "webscorebungfire.firebaseapp.com",
      projectId: "webscorebungfire",
      storageBucket: "webscorebungfire.firebasestorage.app",
      messagingSenderId: "1088110071642",
      appId: "1:1088110071642:web:037a36b00e84aa432ead63"
    };
    const ADMIN_EMAIL = "thebungnot10@gmail.com";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const state = { camps: [], records: [], selectedCampId: null, isAdmin: false, currentUserEmail: null };

    const RESULT_META = {
      win:  { label: "‡∏ä‡∏ô‡∏∞", icon: "‚úÖ", className: "win", weight: 1.0 },
      lose: { label: "‡πÅ‡∏û‡πâ", icon: "‚ùå", className: "lose", weight: 0.0 },
      jao:  { label: "‡∏à‡∏≤‡∏ß", icon: "‚õîÔ∏è", className: "jao", weight: 0.4 }
    };

    const el = {
      searchInput: document.getElementById("searchInput"),
      campGrid: document.getElementById("campGrid"),
      detailOverlay: document.getElementById("detailOverlay"),
      detailContent: document.getElementById("detailContent"),

      adminFab: document.getElementById("adminFab"),
      adminModal: document.getElementById("adminModal"),
      closeAdminModal: document.getElementById("closeAdminModal"),
      adminStateText: document.getElementById("adminStateText"),
      logoutBtn: document.getElementById("logoutBtn"),
      adminLoginCard: document.getElementById("adminLoginCard"),
      adminAddCampCard: document.getElementById("adminAddCampCard"),
      adminAddRecordCard: document.getElementById("adminAddRecordCard"),
      adminEmailInput: document.getElementById("adminEmailInput"),
      adminPasswordInput: document.getElementById("adminPasswordInput"),
      loginBtn: document.getElementById("loginBtn"),
      newCampName: document.getElementById("newCampName"),
      addCampBtn: document.getElementById("addCampBtn"),
      recordCampSelect: document.getElementById("recordCampSelect"),
      recordDate: document.getElementById("recordDate"),
      recordScore: document.getElementById("recordScore"),
      recordResult: document.getElementById("recordResult"),
      addRecordBtn: document.getElementById("addRecordBtn")
    };

    window.startApp = function() { document.getElementById('welcome-screen').style.display = 'none'; }
    window.closeDetail = function() { el.detailOverlay.style.display = 'none'; state.selectedCampId = null; }

    function setDefaultDate() {
      const d = new Date(); const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, "0"); const day = String(d.getDate()).padStart(2, "0");
      el.recordDate.value = `${y}-${m}-${day}`;
    }

    function formatThaiShort(isoDate) {
      if (!isoDate) return "-"; const d = new Date(isoDate + "T00:00:00"); if (isNaN(d.getTime())) return isoDate;
      const dd = String(d.getDate()).padStart(2, "0"); const mm = String(d.getMonth() + 1).padStart(2, "0"); const yy = String(d.getFullYear() + 543).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    function getMergedCamps() {
      const map = new Map();
      for (const camp of state.camps) map.set(camp.id, { ...camp, records: [] });
      for (const rec of state.records) { const target = map.get(rec.campId); if (target) target.records.push(rec); }
      return Array.from(map.values());
    }

    function getCampById(campId) { return getMergedCamps().find(c => c.id === campId) || null; }

    function sortRecords(records) {
      return [...records].sort((a, b) => {
        if ((a.date || "") === (b.date || "")) return (b.score || 0) - (a.score || 0);
        return (b.date || "").localeCompare(a.date || "");
      });
    }

    function getStats(camp) {
      const total = camp.records.length;
      const win = camp.records.filter(r => r.result === "win").length;
      const lose = camp.records.filter(r => r.result === "lose").length;
      const jao = camp.records.filter(r => r.result === "jao").length;
      const avgScore = total ? Math.round(camp.records.reduce((sum, r) => sum + (Number(r.score) || 0), 0) / total) : 0;
      const weighted = total ? Math.round((camp.records.reduce((sum, r) => sum + (RESULT_META[r.result]?.weight ?? 0), 0) / total) * 100) : 0;
      return { total, win, lose, jao, avgScore, weighted };
    }

    function escapeHtml(text) { return String(text).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;"); }

    // ------------------------------------
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢
    // ------------------------------------
    function renderCampList() {
      const merged = getMergedCamps();
      const sortedByRecords = [...merged].sort((a, b) => {
        const diff = (b.records?.length || 0) - (a.records?.length || 0);
        if (diff !== 0) return diff; return (a.name || "").localeCompare(b.name || "", "th");
      });

      const q = el.searchInput.value.trim().toLowerCase();
      const visible = q ? sortedByRecords.filter(c => (c.name || "").toLowerCase().includes(q)) : sortedByRecords;

      el.campGrid.innerHTML = "";
      if (!visible.length) {
        el.campGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; font-size: 1.5rem; color: #666;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ</div>`;
        return;
      }

      visible.forEach(camp => {
        const btn = document.createElement("button");
        btn.className = "camp-btn-red";
        btn.textContent = escapeHtml(camp.name);
        btn.onclick = () => {
          state.selectedCampId = camp.id;
          renderDetail();
          el.detailOverlay.style.display = "block";
          el.detailOverlay.scrollTo(0,0);
        };
        el.campGrid.appendChild(btn);
      });
    }

    // ------------------------------------
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á
    // ------------------------------------
    function renderDetail() {
      const camp = state.selectedCampId ? getCampById(state.selectedCampId) : null;
      if (!camp) return;

      const stats = getStats(camp);
      const rows = sortRecords(camp.records);

      let historyHtml = "";
      if (!rows.length) {
        historyHtml = `<div style="text-align:center; font-size:1.5rem; color:#666; margin-top:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
      } else {
        historyHtml = rows.map(r => {
          const meta = RESULT_META[r.result] || RESULT_META.lose;
          return `
            <div class="history-card ${meta.className}">
              <div style="margin-bottom:5px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiShort(r.date)}</div>
              <div style="font-size: 1.6rem; color:#000;">‡∏™‡∏Å‡∏≠‡∏£‡πå: ${r.score} ${meta.icon}</div>
              ${state.isAdmin ? `
                <div class="inline-actions">
                  <button class="mini-btn edit" onclick="window.editRecordById('${r.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                  <button class="mini-btn danger" onclick="window.deleteRecordById('${r.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
                </div>
              ` : ""}
            </div>
          `;
        }).join("");
      }

      el.detailContent.innerHTML = `
        <div class="detail-title">${escapeHtml(camp.name)}</div>
        
        ${state.isAdmin ? `
          <div class="admin-actions-top">
            <button class="mini-btn edit" onclick="window.renameSelectedCamp()">‚úèÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢</button>
            <button class="mini-btn danger" onclick="window.deleteSelectedCamp()">üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á</button>
          </div>
        ` : ""}

        <div class="stat-box big">
          <div class="label">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô</div>
          <div class="val">${stats.weighted}%</div>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div class="stat-box">
            <div class="label">‡πÅ‡∏Ç‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="val">${stats.total}</div>
          </div>
          <div class="stat-box">
            <div class="label">‡∏ä‡∏ô‡∏∞ ‚úÖ</div>
            <div class="val">${stats.win}</div>
          </div>
          <div class="stat-box">
            <div class="label">‡πÅ‡∏û‡πâ ‚ùå</div>
            <div class="val">${stats.lose}</div>
          </div>
          <div class="stat-box">
            <div class="label">‡∏à‡∏≤‡∏ß ‚õîÔ∏è</div>
            <div class="val">${stats.jao}</div>
          </div>
        </div>

        <h3 style="font-size:1.8rem; margin-top:20px; border-bottom:2px solid #ccc; padding-bottom:10px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
        ${historyHtml}
      `;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞)
    function renderAdminCampSelect() {
      const camps = getMergedCamps().sort((a, b) => a.name.localeCompare(b.name, "th"));
      el.recordCampSelect.innerHTML = "";
      camps.forEach(camp => {
        const opt = document.createElement("option");
        opt.value = camp.id; opt.textContent = camp.name;
        el.recordCampSelect.appendChild(opt);
      });
    }

    function refreshAdminUI() {
      if (state.isAdmin) {
        el.adminStateText.textContent = `‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${state.currentUserEmail}`;
        el.logoutBtn.style.display = "block"; el.adminLoginCard.style.display = "none";
        el.adminAddCampCard.style.display = "block"; el.adminAddRecordCard.style.display = "block";
        renderAdminCampSelect();
      } else {
        el.adminStateText.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
        el.logoutBtn.style.display = state.currentUserEmail ? "block" : "none";
        el.adminLoginCard.style.display = state.currentUserEmail ? "none" : "block";
        el.adminAddCampCard.style.display = "none"; el.adminAddRecordCard.style.display = "none";
      }
    }

    function startRealtimeListeners() {
      onSnapshot(collection(db, "camps"), (snap) => {
        state.camps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderCampList(); 
        if(state.selectedCampId) renderDetail();
        if (state.isAdmin) renderAdminCampSelect();
      });
      onSnapshot(collection(db, "records"), (snap) => {
        state.records = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderCampList();
        if(state.selectedCampId) renderDetail();
      });
    }

    // ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    el.loginBtn.addEventListener("click", async () => {
      const e = el.adminEmailInput.value.trim(), p = el.adminPasswordInput.value;
      if (!e || !p) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      try { await signInWithEmailAndPassword(auth, e, p); el.adminPasswordInput.value = ""; } 
      catch (err) { alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
    });
    el.logoutBtn.addEventListener("click", () => signOut(auth));
    onAuthStateChanged(auth, (user) => {
      state.currentUserEmail = user?.email || null;
      state.isAdmin = !!(user?.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
      refreshAdminUI(); renderCampList(); if(state.selectedCampId) renderDetail();
    });

    el.addCampBtn.addEventListener("click", async () => {
      if (!state.isAdmin) return;
      const name = el.newCampName.value.trim(); if (!name) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢");
      if (state.camps.some(c => (c.name||"").toLowerCase() === name.toLowerCase())) return alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥");
      await addDoc(collection(db, "camps"), { name, createdAt: serverTimestamp() });
      el.newCampName.value = ""; alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    });

    el.addRecordBtn.addEventListener("click", async () => {
      if (!state.isAdmin) return;
      const campId = el.recordCampSelect.value, date = el.recordDate.value, score = Number(el.recordScore.value), result = el.recordResult.value;
      if (!campId || !date || isNaN(score)) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      await addDoc(collection(db, "records"), { campId, date, score, result, createdAt: serverTimestamp() });
      el.recordScore.value = ""; setDefaultDate(); alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß");
    });

    window.editRecordById = async (id) => {
      if (!state.isAdmin) return; const rec = state.records.find(r => r.id === id); if(!rec) return;
      const nd = prompt("‡πÅ‡∏Å‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà YYYY-MM-DD", rec.date||""); if(!nd) return;
      const ns = prompt("‡πÅ‡∏Å‡πâ‡∏™‡∏Å‡∏≠‡∏£‡πå", rec.score||""); if(!ns) return;
      const nr = prompt("‡πÅ‡∏Å‡πâ‡∏ú‡∏•: win / lose / jao", rec.result||"win"); if(!nr) return;
      await updateDoc(doc(db, "records", id), { date: nd, score: Number(ns), result: nr });
    };
    window.deleteRecordById = async (id) => {
      if (!state.isAdmin) return; if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db, "records", id));
    };
    window.renameSelectedCamp = async () => {
      if (!state.isAdmin || !state.selectedCampId) return;
      const camp = getCampById(state.selectedCampId);
      const nn = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà", camp.name);
      if (nn && nn.trim()) await updateDoc(doc(db, "camps", camp.id), { name: nn.trim() });
    };
    window.deleteSelectedCamp = async () => {
      if (!state.isAdmin || !state.selectedCampId) return;
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡πà‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
      const camp = getCampById(state.selectedCampId);
      const batch = writeBatch(db);
      batch.delete(doc(db, "camps", camp.id));
      const snap = await getDocs(query(collection(db, "records"), where("campId", "==", camp.id)));
      snap.forEach(d => batch.delete(doc(db, "records", d.id)));
      await batch.commit(); window.closeDetail(); alert("‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    };

    // Events ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    el.searchInput.addEventListener("input", renderCampList);
    el.adminFab.addEventListener("click", () => { el.adminModal.classList.add("show"); refreshAdminUI(); });
    el.closeAdminModal.addEventListener("click", () => el.adminModal.classList.remove("show"));
    el.adminModal.addEventListener("click", (e) => { if(e.target===el.adminModal) el.adminModal.classList.remove("show"); });

    setDefaultDate();
    startRealtimeListeners();
  </script>
</body>
</html>
